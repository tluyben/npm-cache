#!/usr/bin/env node

const fs = require('fs-extra');
const path = require('path');
const { glob } = require('glob');
const { spawn } = require('child_process');

async function findPackageJsonFiles(rootDir) {
  console.log(`Scanning for package.json files in ${rootDir}...`);

  const pattern = '**/package.json';
  const ignore = ['**/node_modules/**', '**/dist/**', '**/build/**'];

  const files = await glob(pattern, {
    cwd: rootDir,
    absolute: true,
    ignore: ignore
  });

  return files;
}

async function extractDependencies(packageJsonPath) {
  try {
    const packageJson = await fs.readJson(packageJsonPath);
    const dependencies = new Map();

    // Collect all types of dependencies with their version specs
    const depTypes = [
      'dependencies',
      'devDependencies',
      'peerDependencies',
      'optionalDependencies'
    ];

    for (const depType of depTypes) {
      if (packageJson[depType]) {
        for (const [name, versionSpec] of Object.entries(packageJson[depType])) {
          // Store all version specs for each package (in case different projects use different versions)
          if (!dependencies.has(name)) {
            dependencies.set(name, new Set());
          }
          dependencies.get(name).add(versionSpec);
        }
      }
    }

    // Convert to array of {name, versions} objects
    return Array.from(dependencies.entries()).map(([name, versions]) => ({
      name,
      versions: Array.from(versions)
    }));
  } catch (error) {
    console.error(`Error reading ${packageJsonPath}: ${error.message}`);
    return [];
  }
}

async function addPackageToCache(packageSpec) {
  return new Promise((resolve, reject) => {
    const addNpmScript = path.join(__dirname, 'add-npm');
    const proc = spawn(addNpmScript, [packageSpec], {
      stdio: 'inherit'
    });

    proc.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Failed to add ${packageSpec}`));
      }
    });

    proc.on('error', (error) => {
      reject(error);
    });
  });
}

async function main() {
  const targetDir = process.argv[2] || process.cwd();

  if (!await fs.pathExists(targetDir)) {
    console.error(`Error: Directory ${targetDir} does not exist`);
    process.exit(1);
  }

  console.log('Scanning projects for dependencies...\n');

  // Find all package.json files
  const packageJsonFiles = await findPackageJsonFiles(targetDir);

  if (packageJsonFiles.length === 0) {
    console.log('No package.json files found.');
    process.exit(0);
  }

  console.log(`Found ${packageJsonFiles.length} package.json file(s)\n`);

  // Collect all unique dependencies with their version specs
  const allDependencies = new Map();

  for (const packageJsonPath of packageJsonFiles) {
    console.log(`Processing: ${packageJsonPath}`);
    const deps = await extractDependencies(packageJsonPath);

    // Merge dependencies
    for (const { name, versions } of deps) {
      if (!allDependencies.has(name)) {
        allDependencies.set(name, new Set());
      }
      versions.forEach(v => allDependencies.get(name).add(v));
    }
  }

  // Build list of package specs to cache
  const packageSpecs = [];
  for (const [name, versions] of allDependencies.entries()) {
    for (const version of versions) {
      packageSpecs.push(`${name}@${version}`);
    }
  }

  packageSpecs.sort();

  console.log(`\nFound ${allDependencies.size} unique packages with ${packageSpecs.length} version spec(s):\n`);

  // Group by package for display
  for (const [name, versions] of Array.from(allDependencies.entries()).sort()) {
    const versionList = Array.from(versions).join(', ');
    console.log(`  - ${name}: ${versionList}`);
  }

  console.log('\nCaching dependencies...\n');

  let successCount = 0;
  let failCount = 0;

  for (const spec of packageSpecs) {
    try {
      console.log(`\n[${successCount + failCount + 1}/${packageSpecs.length}] Caching ${spec}...`);
      await addPackageToCache(spec);
      successCount++;
    } catch (error) {
      console.error(`Failed to cache ${spec}: ${error.message}`);
      failCount++;
    }
  }

  console.log(`\n${'='.repeat(60)}`);
  console.log(`Scan complete!`);
  console.log(`  Success: ${successCount}`);
  console.log(`  Failed: ${failCount}`);
  console.log(`  Total: ${packageSpecs.length}`);
  console.log(`${'='.repeat(60)}\n`);
}

main().catch(error => {
  console.error(`Error: ${error.message}`);
  process.exit(1);
});
