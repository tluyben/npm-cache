#!/usr/bin/env node

const path = require('path');
const fs = require('fs');
const { runServer, parseConfigFile } = require('verdaccio');

const configPath = path.join(__dirname, 'config.yaml');
const storagePath = path.join(process.env.HOME, 'npm-cache');

// Ensure storage directory exists
if (!fs.existsSync(storagePath)) {
  fs.mkdirSync(storagePath, { recursive: true });
  console.log(`Created storage directory: ${storagePath}`);
}

console.log('Starting Verdaccio local registry...');
console.log(`Storage: ${storagePath}`);
console.log('Registry URL: http://localhost:4873');
console.log('');
console.log('To use this registry:');
console.log('  export NPM_CONFIG_REGISTRY=http://localhost:4873/');
console.log('  or: npm config set registry http://localhost:4873/');
console.log('');
console.log('Press Ctrl+C to stop the server');
console.log('');

async function start() {
  try {
    // Parse config to get server settings
    const config = parseConfigFile(configPath);
    const host = config.server?.host || '0.0.0.0';
    const port = config.server?.port || 4873;

    // Get the HTTP server instance from runServer
    const server = await runServer(configPath);

    // Actually start listening
    server.listen(port, host, () => {
      console.log(`Verdaccio is now listening on http://${host}:${port}/`);
    });

    server.on('error', (error) => {
      console.error('Server error:', error);
      process.exit(1);
    });

    process.on('SIGINT', () => {
      console.log('\nShutting down Verdaccio...');
      server.close(() => {
        console.log('Server closed');
        process.exit(0);
      });
    });
  } catch (error) {
    console.error('Failed to start Verdaccio:', error);
    process.exit(1);
  }
}

start();
